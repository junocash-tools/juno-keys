name: release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

env:
  BIN_NAME: juno-keys

jobs:
  create-release:
    runs-on: ubuntu-latest
    steps:
      - name: Create GitHub release (if needed)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          tag="${{ github.ref_name }}"

          if gh -R "${{ github.repository }}" release view "$tag" >/dev/null 2>&1; then
            exit 0
          fi

          notes="Release $tag"
          if [ "$tag" = "v1.0" ]; then
            notes="Initial Version"
          fi

          gh -R "${{ github.repository }}" release create "$tag" --notes "$notes"

  build:
    needs: create-release
    runs-on: ${{ matrix.runs-on }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: linux-amd64
            runs-on: ubuntu-latest
            os: linux
            arch: amd64
            rust_target: x86_64-unknown-linux-musl
            zig_target: x86_64-linux-musl
          - name: linux-arm64
            runs-on: ubuntu-latest
            os: linux
            arch: arm64
            rust_target: aarch64-unknown-linux-musl
            zig_target: aarch64-linux-musl
          - name: darwin-amd64
            runs-on: macos-13
            os: darwin
            arch: amd64
            rust_target: ""
            zig_target: ""
          - name: darwin-arm64
            runs-on: macos-14
            os: darwin
            arch: arm64
            rust_target: ""
            zig_target: ""
    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable

      - name: Add Rust target
        if: matrix.rust_target != ''
        run: rustup target add ${{ matrix.rust_target }}

      - uses: goto-bus-stop/setup-zig@v2
        if: matrix.zig_target != ''
        with:
          version: 0.12.0

      - uses: taiki-e/install-action@v2
        if: matrix.zig_target != ''
        with:
          tool: cargo-zigbuild

      - name: Build binary
        shell: bash
        run: |
          set -euxo pipefail
          mkdir -p dist

          if [ -n "${{ matrix.rust_target }}" ]; then
            cargo zigbuild --release --target "${{ matrix.rust_target }}"
            cp "target/${{ matrix.rust_target }}/release/${BIN_NAME}" "dist/${BIN_NAME}"
            file "dist/${BIN_NAME}" | grep -q "statically linked"
          else
            cargo build --release
            cp "target/release/${BIN_NAME}" "dist/${BIN_NAME}"
          fi

      - name: Package
        shell: bash
        run: |
          set -euxo pipefail
          tag="${{ github.ref_name }}"
          archive="${BIN_NAME}_${tag}_${{ matrix.os }}_${{ matrix.arch }}.tar.gz"

          tar -C dist -czf "dist/${archive}" "${BIN_NAME}"

          if command -v sha256sum >/dev/null 2>&1; then
            sha256sum "dist/${archive}" > "dist/${archive}.sha256"
          else
            shasum -a 256 "dist/${archive}" > "dist/${archive}.sha256"
          fi

      - name: Upload to GitHub release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          set -euxo pipefail
          tag="${{ github.ref_name }}"
          archive="${BIN_NAME}_${tag}_${{ matrix.os }}_${{ matrix.arch }}.tar.gz"
          gh -R "${{ github.repository }}" release upload "$tag" "dist/${archive}" "dist/${archive}.sha256" --clobber
